Важно: Эти запросы используют JOIN, подзапросы и оконные функции, что очень ценится преподавателями.

Топ-5 самых прибыльных категорий товаров:

SQL

SELECT c.name, SUM(oi.price_at_purchase \* oi.quantity) as revenue
FROM categories c
JOIN products p ON c.id = p.category_id
JOIN order_items oi ON p.id = oi.product_id
GROUP BY c.name ORDER BY revenue DESC LIMIT 5;
Пользователи, потратившие больше среднего чека:

SQL

SELECT first_name, email, total_spent FROM users
WHERE total_spent > (SELECT AVG(total_price) FROM orders);
Товары, которые ни разу не заказывали (поиск неликвида):

SQL

SELECT name FROM products p
LEFT JOIN order_items oi ON p.id = oi.product_id
WHERE oi.id IS NULL;
Средний рейтинг товаров по каждой категории:

SQL

SELECT c.name, ROUND(AVG(p.average_rating), 2) as avg_cat_rating
FROM categories c
JOIN products p ON c.id = p.category_id
GROUP BY c.name;
Количество заказов по городам:

SQL

SELECT delivery_city, COUNT(\*) as order_count FROM orders
GROUP BY delivery_city ORDER BY order_count DESC;
Динамика регистраций по месяцам:

SQL

SELECT DATE_TRUNC('month', created_at) as month, COUNT(\*) as new_users
FROM users GROUP BY month ORDER BY month;
Список товаров с критически низким остатком (меньше 5 шт суммарно):

SQL

SELECT p.name, SUM(s.quantity) as total_qty
FROM products p JOIN stocks s ON p.id = s.product_id
GROUP BY p.name HAVING SUM(s.quantity) < 5;
Самые популярные способы оплаты у VIP-клиентов:

SQL

SELECT pm.type, COUNT(\*) FROM payment_methods pm
JOIN orders o ON pm.id = o.payment_method_id
WHERE o.user_id IN (SELECT id FROM users WHERE total_spent > 1000)
GROUP BY pm.type;
Процент использования промокодов в заказах:

SQL

SELECT
ROUND(COUNT(promocode_id) _ 100.0 / COUNT(_), 2) as promo_usage_percent
FROM orders;
Пользователи, оставившие более 3 отзывов:

SQL

SELECT u.email, COUNT(r.id) as review_count
FROM users u JOIN reviews r ON u.id = r.user_id
GROUP BY u.email HAVING COUNT(r.id) > 3;
Суммарная стоимость товаров на каждом складе:

SQL

SELECT w.name, SUM(s.quantity \* p.price) as warehouse_value
FROM warehouses w
JOIN stocks s ON w.id = s.warehouse_id
JOIN products p ON s.product_id = p.id
GROUP BY w.name;
Выручка в текущем месяце по сравнению с предыдущим (LAG):

SQL

SELECT
DATE_TRUNC('month', created_at) as month,
SUM(total_price) as revenue,
LAG(SUM(total_price)) OVER (ORDER BY DATE_TRUNC('month', created_at)) as prev_revenue
FROM orders GROUP BY 1;
Топ-3 самых дорогих товара в каждой категории (Оконная функция):

SQL

SELECT name, price, category_id FROM (
SELECT name, price, category_id,
RANK() OVER (PARTITION BY category_id ORDER BY price DESC) as r
FROM products
) t WHERE r <= 3;
Логи действий конкретного администратора за последнюю неделю:

SQL

SELECT action, details, created_at FROM audit_logs
WHERE user_id = 1 AND created_at > NOW() - INTERVAL '7 days';
Поиск «брошенных» корзин (есть товары, но нет заказа более месяца):

SQL

SELECT u.email FROM users u
JOIN carts c ON u.id = c.user_id
JOIN cart_items ci ON c.id = ci.cart_id
LEFT JOIN orders o ON u.id = o.user_id AND o.created_at > c.updated_at
WHERE o.id IS NULL;
