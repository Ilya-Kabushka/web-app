// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Category {
  id               Int            @id @default(autoincrement())
  name             String         @unique
  description      String?
  products         Product[]
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  parentCategoryId Int?           @map("parent_category_id")
  parentCategory   Category?      @relation("CategoryToCategory", fields: [parentCategoryId], references: [id])
  subcategories    Category[]     @relation("CategoryToCategory")
  categoryImage    CategoryImage?

  @@index([parentCategoryId, id])
  @@map("categories")
}

model CategoryImage {
  id         Int      @id @default(autoincrement())
  url        String
  categoryId Int      @unique @map("category_id")
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("category_images")
}

model Product {
  id              Int              @id @default(autoincrement())
  name            String
  description     String?
  basePrice       Decimal          @map("base_price") @db.Decimal(10, 2)
  categoryId      Int              @map("category_id")
  category        Category         @relation(fields: [categoryId], references: [id])
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  images          ProductImage[]
  isAvailable     Boolean          @default(true) @map("is_available")
  averageRating   Decimal          @map("average_rating") @db.Decimal(3, 2)
  stocks          Stock[]
  cartItems       CartItem[]
  orderItems      OrderItem[]
  reviews         Review[]
  attributeValues AttributeValue[]
  hasVariants     Boolean          @default(false) @map("has_variants")
  productVariants ProductVariant[]

  @@map("products")
}

model Attribute {
  id              Int              @id @default(autoincrement())
  name            String
  value           String
  attributeValues AttributeValue[]

  @@map("attributes")
}

model AttributeValue {
  id                     Int                     @id @default(autoincrement())
  attributeId            Int                     @map("attribute_id")
  productId              Int                     @map("product_id")
  attribute              Attribute               @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  product                Product                 @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantAttributeValues VariantAttributeValue[]

  @@unique([attributeId, productId])
  @@map("attribute_values")
}

model ProductVariant {
  id                     Int                     @id @default(autoincrement())
  productId              Int                     @map("product_id")
  name                   String
  additionalPrice        Decimal                 @map("additional_price") @db.Decimal(10, 2)
  product                Product                 @relation(fields: [productId], references: [id], onDelete: Cascade)
  stock                  Int                     @default(0)
  price                  Decimal                 @db.Decimal(10, 2)
  createdAt              DateTime                @default(now()) @map("created_at")
  updatedAt              DateTime                @updatedAt @map("updated_at")
  variantAttributeValues VariantAttributeValue[]

  @@map("product_variants")
}

model VariantAttributeValue {
  id               Int            @id @default(autoincrement())
  productVariantId Int            @map("product_variant_id")
  attributeValueId Int            @map("attribute_value_id")
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Cascade)
  attributeValue   AttributeValue @relation(fields: [attributeValueId], references: [id], onDelete: Cascade)

  @@unique([productVariantId, attributeValueId])
  @@map("variant_attribute_values")
}

model ProductImage {
  id        Int      @id @default(autoincrement())
  url       String
  productId Int      @map("product_id")
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  isPrimary Boolean  @default(false)

  @@map("product_images")
}

model Warehouse {
  id        Int                @id @default(autoincrement())
  location  String
  name      String
  createdAt DateTime           @default(now()) @map("created_at")
  updatedAt DateTime           @updatedAt @map("updated_at")
  stocks    Stock[]
  workers   WarehouseWorker[]

  @@map("warehouses")
}

model Stock {
  id          Int       @id @default(autoincrement())
  productId   Int       @map("product_id")
  warehouseId Int       @map("warehouse_id")
  quantity    Int
  product     Product   @relation(fields: [productId], references: [id])
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@unique([productId, warehouseId])
  @@map("stocks")
}

model WarehouseWorker {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  warehouseId Int       @map("warehouse_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@unique([userId, warehouseId])
  @@map("warehouse_workers")
}

//Пользователь и роли
model User {
  id             Int                @id @default(autoincrement())
  email          String             @unique
  password       String
  role           Role               @default(USER)
  firstName      String?            @map("first_name")
  lastName       String?            @map("last_name")
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")
  avatarUrl      String?            @map("avatar_url")
  addresses      Address[]
  cart           Cart?
  orders         Order[]
  reviews        Review[]
  paymentMethods PaymentMethod[]
  auditLogs      AuditLog[]
  totalSpent     Decimal            @default(0) @map("total_spent") @db.Decimal(10, 2)
  warehouseWorkers WarehouseWorker[]

  @@map("users")
}

enum Role {
  ADMIN
  USER
  ANALYTICS
  WAREHOUSE_WORKER
}

model Address {
  id       Int    @id @default(autoincrement())
  street   String
  city     String
  postCode String @map("post_code")
  userId   Int    @map("user_id")
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("addresses")
}

//________________________________________________
//Корзина и заказы
model Cart {
  id     Int  @id @default(autoincrement())
  userId Int  @unique @map("user_id")
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  items CartItem[]

  @@map("carts")
}

model CartItem {
  id        Int     @id @default(autoincrement())
  cartId    Int     @map("cart_id")
  productId Int     @map("product_id")
  quantity  Int
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id])

  @@unique([cartId, productId])
  @@map("cart_items")
}

//Заказы
model Order {
  id              Int            @id @default(autoincrement())
  userId          Int            @map("user_id")
  user            User           @relation(fields: [userId], references: [id])
  totalPrice      Decimal        @map("total_price") @db.Decimal(10, 2)
  status          OrderStatus    @default(PENDING)
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  // Связь с адресом (аналитика)
  addressId       Int?           @map("address_id")
  // Текстовый слепок адреса (безопасность данных)
  deliveryCity    String         @map("delivery_city")
  deliveryStreet  String         @map("delivery_street")
  orderItems      OrderItem[]
  promocodeId     Int?           @map("promocode_id")
  promocode       Promocode?     @relation(fields: [promocodeId], references: [id])
  paymentMethodId Int?           @map("payment_method_id")
  paymentMethod   PaymentMethod? @relation(fields: [paymentMethodId], references: [id])

  @@map("orders")
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELED
}

model OrderItem {
  id              Int     @id @default(autoincrement())
  orderId         Int     @map("order_id")
  productId       Int     @map("product_id")
  quantity        Int
  priceAtPurchase Decimal @db.Decimal(10, 2)
  order           Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product         Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

//Лояльность и оплата + отзывы
model Review {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  productId Int      @map("product_id")
  rating    Int
  comment   String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, productId])
  @@map("reviews")
}

model Promocode {
  id         Int      @id @default(autoincrement())
  code       String   @unique
  discount   Decimal  @db.Decimal(5, 2)
  validFrom  DateTime @map("valid_from")
  validUntil DateTime @map("valid_until")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  orders     Order[]

  @@map("promocodes")
}

model PaymentMethod {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  type      String
  details   String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  orders    Order[]

  @@map("payment_methods")
}

//Логи
model AuditLog {
  id         Int      @id @default(autoincrement())
  userId     Int?     @map("user_id")
  action     String
  timestamp  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])
  entityId   Int?     @map("entity_id")
  entityType String?  @map("entity_type")
  details    String?

  @@map("audit_logs")
}
